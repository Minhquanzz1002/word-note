<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.vn.toeic.mapper.IVocabularyMapper">

    <resultMap id="BaseResultMap" type="com.vn.toeic.entity.Vocabulary">
        <id property="wordId" column="word_id" jdbcType="INTEGER" />
        <result property="word" column="word" jdbcType="VARCHAR" />
        <result property="meaning" column="meaning" jdbcType="VARCHAR" />
        <result property="synonyms" column="synonyms" jdbcType="VARCHAR" />
        <result property="example" column="example" jdbcType="VARCHAR" />
        <result property="wordType" column="word_type" jdbcType="VARCHAR" />

        <!-- BaseEntity fields -->
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP" />
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP" />
        <result property="creator" column="creator" jdbcType="INTEGER" />
        <result property="updater" column="updater" jdbcType="INTEGER" />
        <result property="delFlg" column="del_flg" jdbcType="TINYINT"/>
        <result property="versionNo" column="version_no" jdbcType="INTEGER"/>
    </resultMap>

    <insert id="save" parameterType="com.vn.toeic.entity.Vocabulary">
        INSERT INTO vocabularies (
            word,
            meaning,
            synonyms,
            example,
            created_at,
            updated_at,
            del_flg,
            version_no
        ) VALUES (
            #{word, jdbcType=VARCHAR},
            #{meaning, jdbcType=VARCHAR},
            #{synonyms, jdbcType=VARCHAR},
            #{example, jdbcType=VARCHAR},
            #{createdAt, jdbcType=TIMESTAMP},
            #{updatedAt, jdbcType=TIMESTAMP},
            #{delFlg, jdbcType=TINYINT},
            #{versionNo, jdbcType=INTEGER}
        )
    </insert>

    <update id="update" parameterType="com.vn.toeic.entity.Vocabulary">
        UPDATE vocabularies
        SET
            word = #{word, jdbcType=VARCHAR},
            meaning = #{meaning, jdbcType=VARCHAR},
            synonyms = #{synonyms, jdbcType=VARCHAR},
            example = #{example, jdbcType=VARCHAR},
            updated_at = #{updatedAt, jdbcType=TIMESTAMP},
            version_no = version_no + ${@com.vn.toeic.common.Constant$Number@ONE}
        WHERE
            word_id = #{wordId, jdbcType=INTEGER}
            AND del_flg = ${@com.vn.toeic.common.Constant$DelFlg@NOT_DELETED}
    </update>

    <update id="delete" parameterType="com.vn.toeic.entity.Vocabulary">
        UPDATE vocabularies
        SET
            del_flg = ${@com.vn.toeic.common.Constant$DelFlg@DELETED},
            updated_at = #{updatedAt, jdbcType=TIMESTAMP}
        WHERE
            word_id = #{wordId, jdbcType=INTEGER}
            AND del_flg = ${@com.vn.toeic.common.Constant$DelFlg@NOT_DELETED}
    </update>

    <select id="findById" parameterType="int" resultMap="BaseResultMap">
        SELECT
            word_id,
            word,
            meaning,
            synonyms,
            example,
            created_at,
            updated_at,
            del_flg,
            version_no
        FROM
            vocabularies
        WHERE
            word_id = #{wordId, jdbcType=INTEGER}
            AND del_flg = ${@com.vn.toeic.common.Constant$DelFlg@NOT_DELETED}
    </select>

    <select id="getAllByCreator" resultType="com.vn.toeic.entity.Vocabulary">
        SELECT
            WORD_ID,
            WORD,
            MEANING,
            SYNONYMS,
            EXAMPLE,
            WORD_TYPE,
            UPDATER,
            CREATOR,
            UPDATED_AT,
            CREATED_AT,
            DEL_FLG,
            VERSION_NO
        FROM
            VOCABULARIES
        WHERE
            CREATOR = #{creator, jdbcType=INTEGER}
            <if test="keyword != null and keyword != ''">
                AND WORD like CONCAT('%', #{keyword, jdbcType=VARCHAR}, '%')
            </if>
            AND DEL_FLG = ${@com.vn.toeic.common.Constant$DelFlg@NOT_DELETED}
        ORDER BY
            UPDATED_AT DESC
        OFFSET #{offset, jdbcType=INTEGER}
        LIMIT #{limit, jdbcType=INTEGER}
    </select>

    <select id="existsVocabularyByCreatorAndWord" resultType="boolean">
        SELECT
            CASE WHEN COUNT(*) > 0 THEN TRUE ELSE FALSE END
        FROM
            VOCABULARIES
        WHERE
            CREATOR = #{creator, jdbcType=INTEGER}
            AND WORD = #{wordId, jdbcType=VARCHAR}
            AND DEL_FLG = ${@com.vn.toeic.common.Constant$DelFlg@NOT_DELETED}
    </select>

</mapper>
